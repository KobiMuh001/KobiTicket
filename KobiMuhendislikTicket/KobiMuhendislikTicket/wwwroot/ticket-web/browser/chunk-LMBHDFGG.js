import{a as m}from"./chunk-SV5AFNMF.js";import{L as e,O as h,T as d,_b as p,a as l,b as u,dc as g,j as f}from"./chunk-ECSZKSZ4.js";var $=(()=>{class s{constructor(t,i){this.http=t,this.authService=i,this.apiUrl=g.apiUrl,this.unreadCountSubject=new f(0),this.unreadCount$=this.unreadCountSubject.asObservable(),this.notificationsSubject=new f([]),this.notifications$=this.notificationsSubject.asObservable(),this.notificationsList$=this.notificationsSubject.asObservable(),this.pollingInterval=null}initializeStaffNotifications(){if(this.pollingInterval){console.log("Staff notifications polling already started");return}console.log("Initializing staff notifications..."),this.getStaffNotifications(20).subscribe({next:()=>console.log("Staff notifications loaded"),error:t=>console.error("Staff notifications load error:",t)}),this.pollingInterval=setInterval(()=>{console.log("Staff notifications polling..."),this.getStaffNotifications(20).subscribe({error:t=>console.error("Staff notifications polling error:",t)})},3e4)}initializeAdminNotifications(){if(this.pollingInterval){console.log("Admin notifications polling already started");return}console.log("Initializing admin notifications..."),this.getNotifications(20).subscribe({next:()=>console.log("Admin notifications loaded"),error:t=>console.error("Admin notifications load error:",t)}),this.pollingInterval=setInterval(()=>{console.log("Admin notifications polling..."),this.getNotifications(20).subscribe({error:t=>console.error("Admin notifications polling error:",t)})},3e4)}initializeCustomerNotifications(){if(this.pollingInterval){console.log("Customer notifications polling already started");return}console.log("Initializing customer notifications..."),this.getCustomerNotifications(20).subscribe({next:()=>console.log("Customer notifications loaded"),error:t=>console.error("Customer notifications load error:",t)}),this.pollingInterval=setInterval(()=>{console.log("Customer notifications polling..."),this.getCustomerNotifications(20).subscribe({error:t=>console.error("Customer notifications polling error:",t)})},3e4)}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null,console.log("Notifications polling stopped"))}getNotifications(t=20){return this.http.get(`${this.apiUrl}/admin/notifications?take=${t}`).pipe(e(i=>{i.success&&(this.notificationsSubject.next(i.data||[]),this.unreadCountSubject.next(i.unreadCount||0))}))}getStaffNotifications(t=20){return this.http.get(`${this.apiUrl}/staff/notifications?take=${t}`).pipe(e(i=>{i.success&&(this.notificationsSubject.next(i.data||[]),this.unreadCountSubject.next(i.unreadCount||0))}))}getCustomerNotifications(t=20){return this.http.get(`${this.apiUrl}/tickets/notifications?take=${t}`).pipe(e(i=>{i.success&&(this.notificationsSubject.next(i.data||[]),this.unreadCountSubject.next(i.unreadCount||0))}))}getUnreadCount(){return this.http.get(`${this.apiUrl}/admin/notifications/unread-count`).pipe(e(t=>{t.success&&this.unreadCountSubject.next(t.count)}))}markAsRead(t){let i=this.authService.getCurrentUser(),o=i?.role==="Staff"?`${this.apiUrl}/staff/notifications/${t}/read`:i?.role==="Customer"?`${this.apiUrl}/tickets/notifications/${t}/read`:`${this.apiUrl}/admin/notifications/${t}/read`;return this.http.patch(o,{}).pipe(e(()=>{let n=this.notificationsSubject.value.map(r=>r.id===t?u(l({},r),{isRead:!0}):r);this.notificationsSubject.next(n),this.unreadCountSubject.next(Math.max(0,this.unreadCountSubject.value-1))}))}markAllAsRead(){let t=this.authService.getCurrentUser(),i=t?.role==="Staff"?`${this.apiUrl}/staff/notifications/read-all`:t?.role==="Customer"?`${this.apiUrl}/tickets/notifications/read-all`:`${this.apiUrl}/admin/notifications/read-all`;return this.http.patch(i,{}).pipe(e(()=>{let a=this.notificationsSubject.value.map(n=>u(l({},n),{isRead:!0}));this.notificationsSubject.next(a),this.unreadCountSubject.next(0)}))}deleteNotification(t){let i=this.authService.getCurrentUser(),o=i?.role==="Staff"?`${this.apiUrl}/staff/notifications/${t}`:i?.role==="Customer"?`${this.apiUrl}/tickets/notifications/${t}`:`${this.apiUrl}/admin/notifications/${t}`;return this.http.delete(o).pipe(e(()=>{let a=this.notificationsSubject.value,n=a.find(c=>c.id===t),r=a.filter(c=>c.id!==t);this.notificationsSubject.next(r),n&&!n.isRead&&this.unreadCountSubject.next(Math.max(0,this.unreadCountSubject.value-1))}))}getNotificationIcon(t){return{NewTicket:"ticket",TicketComment:"comment",TicketStatusChanged:"status",TicketAssigned:"assign",TicketPriorityChanged:"priority",TicketResolved:"resolved",General:"info"}[t]||"info"}getNotificationColor(t){return{NewTicket:"primary",TicketComment:"info",TicketStatusChanged:"warning",TicketAssigned:"success",TicketPriorityChanged:"danger",TicketResolved:"success",General:"secondary"}[t]||"secondary"}addNotificationDirectly(t){let i=this.notificationsSubject.value,o=[t,...i].slice(0,20);this.notificationsSubject.next(o),t.isRead||this.unreadCountSubject.next(this.unreadCountSubject.value+1)}addStaffNotificationDirectly(t){let i={id:t.id?.toString()||t.Id?.toString()||`notif-${Date.now()}`,title:t.title||t.Title||"",message:t.message||t.Message||"",type:t.type||t.Type||"",isRead:t.isRead??t.IsRead??!1,ticketId:t.ticketId?.toString()||t.TicketId?.toString(),createdDate:t.createdDate||t.CreatedDate||new Date().toISOString()};this.addNotificationDirectly(i)}static{this.\u0275fac=function(i){return new(i||s)(d(p),d(m))}}static{this.\u0275prov=h({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();export{$ as a};
