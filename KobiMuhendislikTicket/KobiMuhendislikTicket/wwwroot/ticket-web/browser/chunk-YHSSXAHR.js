import{e as g}from"./chunk-MFIIAS3B.js";import{L as i,O as l,T as n,Wb as u,_b as f,dc as h,j as m,sa as c}from"./chunk-3PZ5LAVE.js";var U=(()=>{class a{constructor(t,e,r){this.http=t,this.router=e,this.apiUrl=h.apiUrl,this.currentUserSubject=new m(null),this.currentUser$=this.currentUserSubject.asObservable(),this.isBrowser=u(r),this.loadUserFromToken()}loadUserFromToken(){if(!this.isBrowser)return;let t=localStorage.getItem("token"),e=localStorage.getItem("companyName");if(t||(t=sessionStorage.getItem("token"),e=sessionStorage.getItem("companyName")),t){let r=this.decodeToken(t);e&&(r.companyName=e),this.currentUserSubject.next(r)}}login(t,e=!1){return this.http.post(`${this.apiUrl}/auth/login`,t).pipe(i(r=>{if(this.isBrowser){let s=e?localStorage:sessionStorage;s.setItem("token",r.token),s.setItem("companyName",r.companyName),localStorage.setItem("rememberMe",e?"true":"false")}let o=this.decodeToken(r.token);o.companyName=r.companyName,this.currentUserSubject.next(o)}))}staffLogin(t,e=!1){return this.http.post(`${this.apiUrl}/auth/staff/login`,t).pipe(i(r=>{if(this.isBrowser){let s=e?localStorage:sessionStorage;s.setItem("token",r.token),s.setItem("staffId",r.staffId),s.setItem("fullName",r.fullName),s.setItem("department",r.department),localStorage.setItem("rememberMe",e?"true":"false")}let o=this.decodeToken(r.token);o.staffId=r.staffId,o.fullName=r.fullName,o.department=r.department,this.currentUserSubject.next(o)}))}logout(){let t=this.currentUserSubject.value,e=t?.role==="Admin"||t?.role==="Staff";this.isBrowser&&(localStorage.removeItem("token"),localStorage.removeItem("companyName"),localStorage.removeItem("rememberMe"),localStorage.removeItem("staffId"),localStorage.removeItem("fullName"),localStorage.removeItem("department"),sessionStorage.removeItem("token"),sessionStorage.removeItem("companyName"),sessionStorage.removeItem("staffId"),sessionStorage.removeItem("fullName"),sessionStorage.removeItem("department")),this.currentUserSubject.next(null),this.router.navigate([e?"/staff-login":"/login"])}getToken(){return this.isBrowser?localStorage.getItem("token")||sessionStorage.getItem("token"):null}isAuthenticated(){let t=this.getToken();if(!t)return!1;try{let r=JSON.parse(atob(t.split(".")[1])).exp*1e3;return Date.now()<r}catch{return!1}}isAdmin(){return this.currentUserSubject.value?.role==="Admin"}isStaff(){return this.currentUserSubject.value?.role==="Staff"}isCustomer(){return this.currentUserSubject.value?.role==="Customer"}decodeToken(t){try{let e=JSON.parse(atob(t.split(".")[1]));return{identifier:e.sub||e.nameid,companyName:"",role:e["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]||e.role||"Customer",staffId:e.StaffId,fullName:e.FullName}}catch{return{identifier:"",companyName:"",role:"Customer"}}}getCurrentUser(){return this.currentUserSubject.value}getStaffId(){return this.isBrowser?localStorage.getItem("staffId")||sessionStorage.getItem("staffId"):null}static{this.\u0275fac=function(e){return new(e||a)(n(f),n(g),n(c))}}static{this.\u0275prov=l({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();export{U as a};
