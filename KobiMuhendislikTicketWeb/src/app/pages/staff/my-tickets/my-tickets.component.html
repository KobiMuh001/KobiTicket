<div class="my-tickets-page">
  <div class="page-header">
    <div class="header-left">
      <h1>Ticketlarım</h1>
      <p class="subtitle">Size atanmış tüm ticketlar</p>
    </div>
  </div>

  @if (error) {
    <div class="alert alert-error">
      {{ error }}
      <button class="close-btn" (click)="error = null">×</button>
    </div>
  }

  @if (successMessage) {
    <div class="alert alert-success">
      {{ successMessage }}
    </div>
  }

  <!-- Filters -->
  <div class="filters-bar">
    <div class="filter-group">
      <label>Durum:</label>
      <select (change)="onStatusFilterChange($event)" [value]="selectedStatus">
        <option value="all">Tümü</option>
        <option *ngFor="let s of statusOptions" [value]="(s.sortOrder ?? s.id) + ''">{{ s.label }}</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Öncelik:</label>
      <select (change)="onPriorityFilterChange($event)" [value]="selectedPriority">
        <option value="all">Tümü</option>
        <option *ngFor="let p of priorityOptions" [value]="(p.sortOrder ?? p.id) + ''">{{ p.label }}</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Müşteri:</label>
      <select (change)="onCustomerFilterChange($event)" [value]="selectedCustomer">
        <option value="all">Tümü</option>
        @for (customer of customers; track customer) {
          <option [value]="customer">{{ customer }}</option>
        }
      </select>
    </div>
    <div class="results-count">
      {{ filteredTickets.length }} ticket bulundu
    </div>
  </div>

  <!-- Tickets Table -->
  <div class="tickets-card">
    @if (isLoading) {
      <div class="loading">Yükleniyor...</div>
    } @else if (filteredTickets.length === 0) {
      <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
          <polyline points="14 2 14 8 20 8"/>
          <path d="M9 15l2 2 4-4"/>
        </svg>
        <p>Henüz size atanmış ticket yok</p>
      </div>
    } @else {
      <div class="table-responsive">
        <table class="tickets-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Başlık</th>
              <th>Müşteri</th>
              <th>Durum</th>
              <th>Öncelik</th>
              <th>Tarih</th>
              <th>İşlemler</th>
            </tr>
          </thead>
          <tbody>
            @for (ticket of filteredTickets; track ticket.id) {
              <tr [routerLink]="['/staff/tickets', ticket.id]" (click)="onTicketSelect(ticket.id)" class="clickable-row" [class.has-notification]="getTicketNotificationCount(ticket.id) > 0">
                <td class="id-cell">
                  <div class="ticket-id-container">
                    <span class="ticket-code">{{ ticket.ticketCode || '#' + ticket.id }}</span>
                    @if (getTicketNotificationCount(ticket.id) > 0) {
                      <span class="notification-badge">{{ getTicketNotificationCount(ticket.id) }}
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                          <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                      </span>
                    }
                  </div>
                </td>
                <td class="title-cell">
                  <span class="ticket-title">{{ ticket.title }}</span>
                  @if (ticket.assetName) {
                    <span class="asset-name">{{ ticket.assetName }}</span>
                  }
                </td>
                <td>{{ ticket.companyName || '-' }}</td>
                <td>
                  <span class="status-badge" [class]="getStatusClass(ticket.status)" [style.background-color]="getStatusColor(ticket.status)" [style.color]="getStatusColor(ticket.status) ? '#fff' : null">
                    {{ getStatusText(ticket.status) }}
                  </span>
                </td>
                <td>
                  <span class="priority-badge" [class]="getPriorityClass(ticket.priority)" [style.background-color]="getPriorityColor(ticket.priority)" [style.color]="getPriorityColor(ticket.priority) ? '#fff' : null">
                    {{ getPriorityText(ticket.priority) }}
                  </span>
                </td>
                <td class="date-cell">{{ formatDate(ticket.createdDate) }}</td>
                <td class="actions-cell" (click)="$event.stopPropagation()">
                  @if (ticket.status !== 4 && ticket.status !== 5) {
                      <button class="action-btn release" (click)="openReleaseConfirm(ticket.id, $event, ticket.title)" 
                              title="Ticketı Bırak">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="21" y1="12" x2="7" y2="12" />
                        <polyline points="14 5 7 12 14 19" />
                      </svg>
                    </button>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="tickets-cards">
        @for (ticket of filteredTickets; track ticket.id) {
          <div class="ticket-card clickable-row" [routerLink]="['/staff/tickets', ticket.id]" (click)="onTicketSelect(ticket.id)" [class.has-notification]="getTicketNotificationCount(ticket.id) > 0">
              <div class="ticket-card-header">
              <div class="ticket-id-container">
                <span class="ticket-code">{{ ticket.ticketCode || '#' + ticket.id }}</span>
                @if (getTicketNotificationCount(ticket.id) > 0) {
                  <span class="notification-badge">{{ getTicketNotificationCount(ticket.id) }}</span>
                }
              </div>
              <span class="status-badge" [class]="getStatusClass(ticket.status)" [style.background-color]="getStatusColor(ticket.status)" [style.color]="getStatusColor(ticket.status) ? '#fff' : null">
                {{ getStatusText(ticket.status) }}
              </span>
            </div>

            <div class="ticket-card-title">
              <span class="ticket-title">{{ ticket.title }}</span>
              @if (ticket.assetName) {
                <span class="asset-name">{{ ticket.assetName }}</span>
              }
            </div>

            <div class="ticket-card-meta">
              <div class="meta-row">
                <span class="meta-label">Müşteri</span>
                <span class="meta-value">{{ ticket.companyName || '-' }}</span>
              </div>
              <div class="meta-row">
                <span class="meta-label">Öncelik</span>
                <span class="priority-badge" [class]="getPriorityClass(ticket.priority)" [style.background-color]="getPriorityColor(ticket.priority)" [style.color]="getPriorityColor(ticket.priority) ? '#fff' : null">
                  {{ getPriorityText(ticket.priority) }}
                </span>
              </div>
              <div class="meta-row">
                <span class="meta-label">Tarih</span>
                <span class="date-cell">{{ formatDate(ticket.createdDate) }}</span>
              </div>
            </div>

            <div class="ticket-card-actions actions-cell" (click)="$event.stopPropagation()">
                @if (ticket.status !== 4 && ticket.status !== 5) {
                <button class="action-btn release" (click)="openReleaseConfirm(ticket.id, $event, ticket.title)" title="Ticketı Bırak">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="21" y1="12" x2="7" y2="12" />
                    <polyline points="14 5 7 12 14 19" />
                  </svg>
                </button>
              }
            </div>
          </div>
        }
      </div>

      <!-- Pagination -->
      <div class="pagination-controls">
        <button class="pagination-btn" (click)="previousPage()" [disabled]="currentPage === 1">
          ← Önceki
        </button>
        
        <div class="page-numbers">
          @for (page of [1, 2, 3]; track page) {
            @if (page <= totalPages) {
              <button 
                class="page-number" 
                [class.active]="page === currentPage"
                (click)="goToPage(page)">
                {{ page }}
              </button>
            }
          }
        </div>

        <button class="pagination-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">
          Sonraki →
        </button>
      </div>
    }
  </div>

  <!-- Release confirmation modal -->
  @if (showReleaseConfirm) {
    <div class="release-overlay" (click)="closeReleaseConfirm()">
      <div class="release-card card" (click)="$event.stopPropagation()">
        <div class="card-header">
          <h3>Ticketı Bırak</h3>
          <button class="modal-close" (click)="closeReleaseConfirm()">×</button>
        </div>
        <div class="card-body">
          <p>Bu ticketı bırakmak istediğinize emin misiniz?</p>
          @if (ticketToReleaseTitle) {
            <p><strong>{{ ticketToReleaseTitle }}</strong></p>
          }
        </div>
        <div class="card-actions">
          <button class="btn btn-outline" (click)="closeReleaseConfirm()">İptal</button>
          <button class="btn btn-danger" (click)="confirmRelease()">Tamam</button>
        </div>
      </div>
    </div>
  }
</div>
