<div class="staff-dashboard">
  <!-- Toast Notification -->
  @if (toastNotification) {
    <div class="toast-container" [class]="'toast-' + toastNotification.type">
      <div class="toast-content">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          @switch(toastNotification.type) {
            @case('success') {
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            }
            @case('error') {
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            }
            @default {
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            }
          }
        </svg>
        <span>{{ toastNotification.message }}</span>
      </div>
    </div>
  }

  <div class="page-header">
    <div class="header-left">
      <h1>Dashboard</h1>
      <p class="subtitle">Ho≈ü geldiniz! ƒ∞≈üte g√ºncel durumunuz.</p>
    </div>
    <div class="header-right">
      <!-- Notifications Widget -->
      <div class="notifications-widget">
        <button class="notification-toggle" [class.has-unread]="unreadNotificationsCount > 0" (click)="toggleNotificationsDropdown()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
          @if (unreadNotificationsCount > 0) {
            <span class="notification-badge">{{ unreadNotificationsCount }}</span>
          }
        </button>
        @if (showNotificationsDropdown) {
          <div class="notifications-dropdown card" (click)="$event.stopPropagation()">
            <div class="dropdown-header card-header">
              <h3>Bildirimler</h3>
              @if (unreadNotificationsCount > 0) {
                <span class="unread-count">{{ unreadNotificationsCount }} yeni</span>
              }
            </div>
            <div class="notifications-list">
              @if (notifications.length === 0) {
                <div class="empty-state">
                  <p>Hen√ºz bildirim yok</p>
                </div>
              } @else {
                <table class="notifications-table">
                  <tbody>
                    @for (notification of notifications.slice(0, 5); track notification.id) {
                      <tr [class.unread]="!notification.isRead" class="notification-row">
                        <td class="notification-cell">
                          <div class="notification-content">
                            <p class="notification-title">{{ notification.title }}</p>
                            <p class="notification-message">{{ notification.message }}</p>
                          </div>
                        </td>
                        <td class="notification-date">{{ formatDate(notification.createdDate) }}</td>
                        <td class="notification-actions-cell">
                          @if (!notification.isRead) {
                            <button class="mark-read-btn" (click)="markNotificationAsRead(notification.id)" title="Okundu olarak i≈üaretle">
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                              </svg>
                            </button>
                          }
                          <button class="delete-btn" (click)="deleteNotification(notification.id)" title="Sil">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <polyline points="3 6 5 6 21 6"></polyline>
                              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                              <line x1="10" y1="11" x2="10" y2="17"></line>
                              <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                          </button>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              }
            </div>
            @if (notifications.length > 5) {
              <div class="dropdown-footer">
                <a routerLink="/staff/my-tickets" class="view-all" (click)="closeNotificationsDropdown()">
                  T√ºm√ºn√º G√∂r
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                    <polyline points="12 5 19 12 12 19"></polyline>
                  </svg>
                </a>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>

  @if (error) {
    <div class="alert alert-error">
      {{ error }}
      <button class="close-btn" (click)="error = null">√ó</button>
    </div>
  }

  <!-- Workload Cards -->
  @if (workload) {
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon processing">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ workload.assignedTickets }}</span>
          <span class="stat-label">Aktif Ticket</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon open">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ workload.openTickets }}</span>
          <span class="stat-label">Bekleyen</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon resolved">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ workload.resolvedToday }}</span>
          <span class="stat-label">Bug√ºn √á√∂z√ºlen</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon capacity">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <line x1="3" y1="9" x2="21" y2="9"/>
            <line x1="9" y1="21" x2="9" y2="9"/>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ getWorkloadPercentage() }}%</span>
          <span class="stat-label">Kapasite</span>
        </div>
        <div class="capacity-bar">
          <div class="capacity-fill" [style.width.%]="getWorkloadPercentage()"
               [class.high]="getWorkloadPercentage() > 80"
               [class.medium]="getWorkloadPercentage() > 50 && getWorkloadPercentage() <= 80">
          </div>
        </div>
      </div>
    </div>
  }

  <div class="dashboard-grid">
    <!-- My Tickets -->
    <div class="dashboard-card">
      <div class="card-header">
        <h2>Aktif Ticketlarƒ±m</h2>
        <a routerLink="/staff/my-tickets" class="view-all">T√ºm√ºn√º G√∂r ‚Üí</a>
      </div>
      <div class="card-body">
        @if (isLoading) {
          <div class="loading">Y√ºkleniyor...</div>
        } @else if (myTickets.length === 0) {
          <div class="empty-state">
            <p>Hen√ºz atanmƒ±≈ü ticket yok</p>
          </div>
        } @else {
          <div class="ticket-list">
            @for (ticket of myTickets; track ticket.id) {
              <a [routerLink]="['/staff/my-tickets', ticket.id]" class="ticket-item">
                <div class="ticket-info">
                  <span class="ticket-title">{{ ticket.title }}</span>
                  <span class="ticket-company">{{ ticket.companyName }}</span>
                </div>
                <div class="ticket-meta">
                  <span class="status" [class]="getStatusClass(ticket.status)">
                    {{ getStatusText(ticket.status) }}
                  </span>
                  <span class="priority" [class]="getPriorityClass(ticket.priority)">
                    {{ getPriorityText(ticket.priority) }}
                  </span>
                </div>
              </a>
            }
          </div>
        }
      </div>
    </div>

    <!-- Unassigned Tickets -->
    <div class="dashboard-card">
      <div class="card-header">
        <h2>A√ßƒ±k Ticketlar</h2>
        <a routerLink="/staff/open-tickets" class="view-all">T√ºm√ºn√º G√∂r ‚Üí</a>
      </div>
      <div class="card-body">
        @if (isLoading) {
          <div class="loading">Y√ºkleniyor...</div>
        } @else if (unassignedTickets.length === 0) {
          <div class="empty-state">
            <p>Bekleyen ticket yok üéâ</p>
          </div>
        } @else {
          <div class="ticket-list">
            @for (ticket of unassignedTickets; track ticket.id) {
              <div class="ticket-item unassigned">
                <div class="ticket-info">
                  <span class="ticket-title">{{ ticket.title }}</span>
                  <span class="ticket-company">{{ ticket.companyName }}</span>
                </div>
                <div class="ticket-actions">
                  <span class="priority" [class]="getPriorityClass(ticket.priority)">
                    {{ getPriorityText(ticket.priority) }}
                  </span>
                  <button class="claim-btn" (click)="claimTicket(ticket.id)" 
                          [disabled]="workload && !workload.isAvailable">
                    √ústlen
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
</div>
