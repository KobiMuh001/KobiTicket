<div class="ticket-detail-container">
  <!-- Back button -->
  <div class="back-nav">
    <button class="back-link" (click)="location.back()">
      ‚Üê Geri D√∂n
    </button>
  </div>

  <!-- Loading state -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Talep y√ºkleniyor...</p>
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="error-message">
    {{ error }}
    <button (click)="error = null" class="close-btn">√ó</button>
  </div>

  <!-- Success message -->
  <div *ngIf="successMessage" class="success-message">
    {{ successMessage }}
    <button (click)="successMessage = null" class="close-btn">√ó</button>
  </div>

  <!-- Ticket content -->
  <div *ngIf="!isLoading && ticket" class="ticket-content">
    <!-- Header -->
    <div class="ticket-header">
      <div class="header-left">
        <h1>{{ ticket.title }}</h1>
        <div class="ticket-meta">
          <span class="ticket-id">{{ ticket.ticketCode || '#' + ticket.id }}</span>
          <span class="badge" [ngClass]="getStatusClass(ticket.status)" [style.background-color]="getStatusColor(ticket.status)" [style.color]="getStatusColor(ticket.status) ? '#fff' : null">{{ getStatusText(ticket.status) }}</span>
          <span class="badge" [ngClass]="getPriorityClass(ticket.priority)" [style.background-color]="getPriorityColor(ticket.priority)" [style.color]="getPriorityColor(ticket.priority) ? '#fff' : null">{{ getPriorityText(ticket.priority) }}</span>
        </div>
      </div>
      <div class="header-actions">
        <!-- Not assigned - Show claim button -->
        <ng-container *ngIf="!ticket.assignedPerson">
          <button (click)="claimTicket()" class="btn btn-primary">
            Talebi √ústlen
          </button>
        </ng-container>
        
        <!-- My ticket - Show action buttons (replace fixed buttons with status selector) -->
        <ng-container *ngIf="isMyTicket && ticket.status !== 4 && ticket.status !== 5">
          <!-- Status selector: shows all statuses from DB; selecting one calls updateStatus -->
          <label class="status-select-label">
            <div class="status-select-wrap">
              <span class="status-pill" [style.background-color]="getStatusColor(ticket.status)"></span>
              <select class="status-dropdown" [value]="ticket.status + ''" (change)="onStatusSelect($event)">
                <option *ngFor="let s of statusOptions" [value]="(s.value ?? s.numericKey ?? s.sortOrder ?? s.id) + ''"
                  [selected]="((s.value ?? s.numericKey ?? s.sortOrder ?? s.id) + '') === (ticket.status + '') || (s.id + '') === (ticket.status + '') || (s.key + '') === (ticket.status + '')">
                  {{ s.label }}
                </option>
              </select>
              <span class="status-caret">‚ñæ</span>
            </div>
          </label>

          <!-- Resolve and Release actions remain -->
          
            <button (click)="releaseTicket()" class="btn btn-secondary">
              Talebi Bƒ±rak
            </button>
          
            <!-- Release Confirmation Modal -->
            <div *ngIf="showReleaseModal" class="modal-overlay" (click)="cancelRelease()">
              <div class="modal-content" (click)="$event.stopPropagation()">
                <div class="modal-header">
                  <h3>Talebi Bƒ±rak</h3>
                  <button (click)="cancelRelease()" class="close-btn">√ó</button>
                </div>
                <div class="modal-body">
                  <p>Bu talebi bƒ±rakmak istediƒüinize emin misiniz?</p>
                </div>
                <div class="modal-footer">
                  <button (click)="cancelRelease()" class="btn btn-secondary">ƒ∞ptal</button>
                  <button (click)="confirmRelease()" class="btn btn-primary" [disabled]="releasing">@if (releasing) { <span class="spinner-sm"></span> } Evet, Bƒ±rak</button>
                </div>
              </div>
            </div>
        </ng-container>
        
        <!-- Assigned to someone else -->
        <span *ngIf="ticket.assignedPerson && !isMyTicket" class="assigned-info">
          Atanan: {{ ticket.assignedPerson }}
        </span>
      </div>
    </div>

    <!-- Main grid -->
    <div class="content-grid">
      <!-- Left column - Details -->
      <div class="detail-section">
        <div class="detail-card">
          <h3>Talep Detaylarƒ±</h3>
          <div class="detail-row">
            <label>A√ßƒ±klama:</label>
            <p class="description">{{ ticket.description }}</p>

        <!-- Confirm Status Change Modal -->
        <div *ngIf="showConfirmStatusModal" class="modal-overlay" (click)="cancelStatusChange()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h3>Durumu Deƒüi≈ütir</h3>
              <button (click)="cancelStatusChange()" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
              <p>Bu talebin durumunu <strong>{{ pendingStatusLabel }}</strong> olarak deƒüi≈ütirmek istediƒüinize emin misiniz?</p>
            </div>
            <div class="modal-footer">
              <button (click)="cancelStatusChange()" class="btn btn-secondary">ƒ∞ptal</button>
              <button (click)="confirmStatusChange()" class="btn btn-primary">Evet, Deƒüi≈ütir</button>
            </div>
          </div>
        </div>
          </div>
          <div class="detail-row">
            <label>Olu≈üturan:</label>
            <span>{{ ticket.creatorName || 'Bilinmiyor' }}</span>
          </div>
          <div class="detail-row">
            <label>Olu≈üturma Tarihi:</label>
            <span>{{ formatDate(ticket.createdDate) }}</span>
          </div>
          <div class="detail-row" *ngIf="ticket.resolvedDate && (ticket.status === 4 || ticket.status === 5)">
            <label>√á√∂z√ºlme Tarihi:</label>
            <span>{{ formatDate(ticket.resolvedDate) }}</span>
          </div>
        </div>

        <div class="detail-card" *ngIf="ticket.asset">
          <h3>Se√ßilen √úr√ºn</h3>
          <div class="detail-row">
            <label>√úr√ºn Adƒ±:</label>
            <span>{{ ticket.asset.productName }}</span>
          </div>
          @if (ticket.asset.description) {
          <div class="detail-row">
            <label>A√ßƒ±klama:</label>
            <span>{{ ticket.asset.description }}</span>
          </div>
          }
        </div>

        <!-- Ticket Image Section -->
        <div class="detail-card" *ngIf="ticket.imagePaths?.length">
          <h3>Eklenen Gorseller</h3>
          <div class="ticket-image-grid">
            <button
              class="ticket-image-tile"
              type="button"
              *ngFor="let image of ticket.imagePaths"
              (click)="openImagePreview(image)">
              <img [src]="baseUrl + '/' + image" [alt]="ticket.title" class="ticket-image">
              <div class="image-overlay">
                <span>B√ºy√ºtmek i√ßin tƒ±kla</span>
              </div>
            </button>
          </div>
        </div>

        <div class="detail-card" *ngIf="ticket.solutionNote">
          <h3>√á√∂z√ºm Notu</h3>
          <p class="solution-note">{{ ticket.solutionNote }}</p>
        </div>
      </div>

      <!-- Right column - Tabs -->
      <div class="activity-section">
        <div class="tabs">
          <button 
            class="tab" 
            [class.active]="activeTab === 'comments'"
            (click)="activeTab = 'comments'; shouldScrollToBottom = true">
            Mesajlar ({{ comments.length }})
          </button>
          <button 
            class="tab" 
            [class.active]="activeTab === 'history'"
            (click)="activeTab = 'history'">
            Ge√ßmi≈ü ({{ history.length }})
          </button>
        </div>

        <!-- Comments Tab -->
        <div *ngIf="activeTab === 'comments'" class="tab-content">
          <!-- Comments list -->
          <div class="comments-list-v2" #commentsContainer>
            <div *ngIf="comments.length === 0" class="empty-state">
              Hen√ºz mesaj yok
            </div>
            <div *ngFor="let comment of comments" class="comment-item-v3" 
                 [ngClass]="isMyComment(comment) ? 'my-message-row' : 'other-message-row'">
              <div class="comment-bubble-v2" [ngClass]="{'admin-bubble': comment.isAdminReply}">
                <div class="bubble-header">
                  <span class="sender-name">{{ comment.authorName }}</span>
                  <span class="support-badge" *ngIf="comment.isAdminReply">DESTEK</span>
                  <span class="message-time">{{ formatTime(comment.createdDate) }}</span>
                </div>
                <p class="message-content-v2">{{ comment.message }}</p>
              </div>
            </div>
          </div>

          <!-- Add comment (only when ticket is assigned to me) -->
          <div class="add-comment-v2" *ngIf="isMyTicket && ticket.status !== 4 && ticket.status !== 5">
            <div class="input-wrapper">
              <textarea 
                [(ngModel)]="newComment" 
                placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..."
                rows="2"></textarea>
              <button (click)="addComment()" class="btn-send-v2" [disabled]="!newComment.trim()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"/>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- History Tab -->
        <div *ngIf="activeTab === 'history'" class="tab-content">
          <div class="history-list">
            <div *ngIf="history.length === 0" class="empty-state">
              Hen√ºz ge√ßmi≈ü yok
            </div>
            <div *ngFor="let item of history" class="history-item">
              <div class="history-icon">
                <span *ngIf="item.action === 'StatusChanged'">üîÑ</span>
                <span *ngIf="item.action === 'Assigned'">üë§</span>
                <span *ngIf="item.action === 'Created'">‚ûï</span>
                <span *ngIf="item.action === 'Resolved'">‚úÖ</span>
              </div>
              <div class="history-content">
                <p>{{ item.description }}</p>
                <span class="history-date">{{ formatDate(item.createdDate) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Resolve Modal -->
<div *ngIf="showResolveModal" class="modal-overlay" (click)="showResolveModal = false">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Talebi √á√∂z</h3>
      <button (click)="showResolveModal = false" class="close-btn">√ó</button>
    </div>
    <div class="modal-body">
      <label>√á√∂z√ºm Notu *</label>
      <textarea 
        [(ngModel)]="solutionNote" 
        placeholder="Yapƒ±lan i≈ülem ve √ß√∂z√ºm√º a√ßƒ±klayƒ±n..."
        rows="5"></textarea>
    </div>
    <div class="modal-footer">
      <button (click)="showResolveModal = false" class="btn btn-secondary">ƒ∞ptal</button>
      <button (click)="resolveTicket()" class="btn btn-success">√á√∂z ve Kapat</button>
    </div>
  </div>
</div>

<!-- Image Preview Modal -->
<div *ngIf="showImagePreview" class="image-preview-overlay" (click)="showImagePreview = false">
  <div class="preview-content" (click)="$event.stopPropagation()">
    <button class="btn-close-preview" (click)="showImagePreview = false">√ó</button>
    <img [src]="baseUrl + '/' + selectedImagePath" alt="B√ºy√ºk G√∂rsel">
  </div>
</div>
