<div class="tenants-page">
  <div class="page-header">
    <div class="header-left">
      <h1 class="page-title">Müşteriler</h1>
      <p class="page-subtitle">Tüm müşterileri görüntüleyin ve yönetin.</p>
    </div>
    <div class="header-right">
      <button class="btn btn-outline" (click)="loadTenants()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        Yenile
      </button>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Yeni Müşteri
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <div class="filters-row">
      <div class="search-box">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input 
          type="text" 
          placeholder="Firma adı, vergi no, e-posta veya telefon ile ara..." 
          [(ngModel)]="searchTerm"
          (keyup.enter)="searchTenants()"
          (input)="applyFilters()"
        />
      </div>
      
      <div class="filter-group">
        @if (searchTerm) {
          <button class="btn btn-outline btn-sm" (click)="clearFilters()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
            Temizle
          </button>
        }
      </div>
    </div>
    
    <div class="results-info">
      <span>{{ filteredTenants.length }} / {{ totalCount }} müşteri gösteriliyor</span>
    </div>
  </div>

  <!-- Content -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Müşteriler yükleniyor...</p>
    </div>
  } @else if (errorMessage) {
    <div class="alert alert-error">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      {{ errorMessage }}
      <button class="btn btn-sm" (click)="errorMessage = ''">Kapat</button>
    </div>
  } @else if (filteredTenants.length === 0) {
    <div class="empty-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      <h3>Müşteri bulunamadı</h3>
      <p>Arama kriterlerinize uygun müşteri bulunmuyor.</p>
    </div>
  } @else {
    <div class="tenants-table-card">
      <div class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th>Firma Adı</th>
              <th>Vergi No</th>
              <th>E-posta</th>
              <th>Telefon</th>
              <th>Kayıt Tarihi</th>
              <th>İşlemler</th>
            </tr>
          </thead>
          <tbody>
            @for (tenant of filteredTenants; track tenant.id) {
              <tr>
                <td>
                  <div class="company-name">
                    <div class="avatar">
                      {{ tenant.companyName.charAt(0).toUpperCase() || '?' }}
                    </div>
                    <span>{{ tenant.companyName }}</span>
                  </div>
                </td>
                <td>
                  <span class="tax-number">{{ tenant.taxNumber }}</span>
                </td>
                <td>{{ tenant.email || '-' }}</td>
                <td>{{ tenant.phoneNumber || '-' }}</td>
                <td>{{ formatDate(tenant.createdDate) }}</td>
                <td>
                  <div class="actions">
                    <a [routerLink]="['/admin/tenants', tenant.id]" class="action-btn" title="Düzenle">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                      </svg>
                    </a>
                    <button class="action-btn action-btn--danger" title="Sil" (click)="openDeleteModal(tenant)">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="tenants-cards">
        @for (tenant of filteredTenants; track tenant.id) {
          <div class="tenant-card">
            <div class="tenant-card-header">
              <div class="company-name">
                <div class="avatar">
                  {{ tenant.companyName.charAt(0).toUpperCase() || '?' }}
                </div>
                <span>{{ tenant.companyName }}</span>
              </div>
              <span class="tax-number">{{ tenant.taxNumber }}</span>
            </div>

            <div class="tenant-card-meta">
              <div class="meta-row">
                <span class="meta-label">E-posta</span>
                <span class="meta-value">{{ tenant.email || '-' }}</span>
              </div>
              <div class="meta-row">
                <span class="meta-label">Telefon</span>
                <span class="meta-value">{{ tenant.phoneNumber || '-' }}</span>
              </div>
              <div class="meta-row">
                <span class="meta-label">Kayıt Tarihi</span>
                <span class="meta-value">{{ formatDate(tenant.createdDate) }}</span>
              </div>
            </div>

            <div class="tenant-card-actions actions">
              <a [routerLink]="['/admin/tenants', tenant.id]" class="action-btn" title="Düzenle">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </a>
              <button class="action-btn action-btn--danger" title="Sil" (click)="openDeleteModal(tenant)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  <line x1="10" y1="11" x2="10" y2="17"/>
                  <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
              </button>
            </div>
          </div>
        }
      </div>
      
      <!-- Pagination -->
      @if (totalPages > 1) {
        <div class="pagination">
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === 1"
            (click)="goToPage(currentPage - 1)"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          
          <span class="pagination-info">
            Sayfa {{ currentPage }} / {{ totalPages }}
          </span>
          
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === totalPages"
            (click)="goToPage(currentPage + 1)"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        </div>
      }
    </div>
  }
</div>

<!-- Delete Modal -->
@if (showDeleteModal && tenantToDelete) {
  <div class="modal-overlay" (click)="closeDeleteModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Müşteri Sil</h3>
        <button class="modal-close" (click)="closeDeleteModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p>
          <strong>{{ tenantToDelete.companyName }}</strong> müşterisini silmek istediğinize emin misiniz?
        </p>
        <div class="warning-box">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          <span>Bu işlem geri alınamaz!</span>
        </div>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="forceDelete" />
          <span>Müşteriye ait tüm varlıkları ve ticketları da sil</span>
        </label>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeDeleteModal()" [disabled]="isDeleting">İptal</button>
        <button class="btn btn-danger" (click)="confirmDelete()" [disabled]="isDeleting">
          @if (isDeleting) {
            <span class="spinner-sm"></span>
            Siliniyor...
          } @else {
            Sil
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Create Modal -->
@if (showCreateModal) {
  <div class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Yeni Müşteri Ekle</h3>
        <button class="modal-close" (click)="closeCreateModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        @if (createError) {
          <div class="form-error">{{ createError }}</div>
        }
        
        <div class="form-group">
          <label for="companyName">Firma Adı *</label>
          <input 
            type="text" 
            id="companyName" 
            [(ngModel)]="createForm.companyName" 
            placeholder="Firma adını girin"
          />
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="taxNumber">Vergi No *</label>
            <input 
              type="text" 
              id="taxNumber" 
              [(ngModel)]="createForm.taxNumber" 
              placeholder="Vergi numarasını girin"
            />
          </div>
          
          <div class="form-group">
            <label for="phoneNumber">Telefon</label>
            <input 
              type="tel" 
              id="phoneNumber" 
              [value]="createForm.phoneNumber"
              (input)="formatPhoneNumber($event)"
              placeholder="0 (5XX) XXX XX XX"
              maxlength="17"
            />
            <small class="form-hint">Örn: 0 (532) 123 45 67</small>
          </div>
        </div>
        
        <div class="form-group">
          <label for="email">E-posta *</label>
          <input 
            type="email" 
            id="email" 
            [(ngModel)]="createForm.email" 
            placeholder="ornek@firma.com"
            pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
          />
          <small class="form-hint">Geçerli bir e-posta adresi girin</small>
        </div>

        <div class="form-group">
          <label for="username">Kullanıcı Adı</label>
          <input
            type="text"
            id="username"
            [(ngModel)]="createForm.username"
            placeholder="ornek_kullanici"
          />
          <small class="form-hint">İsteğe bağlı. Müşteri e-posta/vergi no yerine bununla da giriş yapabilir.</small>
        </div>
        
        <div class="form-group">
          <label for="password">Şifre *</label>
          <input 
            type="password" 
            id="password" 
            [(ngModel)]="createForm.password" 
            placeholder="••••••••"
            minlength="6"
          />
          <small class="form-hint">En az 6 karakter olmalıdır</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeCreateModal()" [disabled]="isCreating">İptal</button>
        <button class="btn btn-primary" (click)="createTenant()" [disabled]="isCreating">
          @if (isCreating) {
            <span class="spinner-sm"></span>
            Oluşturuluyor...
          } @else {
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Müşteri Oluştur
          }
        </button>
      </div>
    </div>
  </div>
}
