<div class="ticket-detail">
  <div class="page-header">
    <a routerLink="/customer/tickets" class="back-link">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
      Taleplerime Dön
    </a>
  </div>

  @if (isLoading) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Yükleniyor...</p>
    </div>
  } @else if (!ticket) {
    <div class="error-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      <h3>Talep Bulunamadı</h3>
      <p>Aradığınız destek talebi bulunamadı veya erişim izniniz yok.</p>
      <a routerLink="/customer/tickets" class="btn-back">Taleplerime Dön</a>
    </div>
  } @else {
    <div class="ticket-content">
      <!-- Left Column: Main Detail -->
      <div class="ticket-left-column">
        <!-- Ticket Header Card -->
        <div class="ticket-header-card">
          <div class="ticket-title-section">
            <span class="ticket-id">#{{ ticket.id }}</span>
            <h1>{{ ticket.title }}</h1>
          </div>
          <div class="header-actions">
            <div class="ticket-badges">
              <span class="badge" [ngClass]="getStatusClass(ticket.status)" [style.background-color]="getStatusColor(ticket.status)" [style.color]="getStatusColor(ticket.status) ? '#fff' : null">{{ ticket.statusText }}</span>
              <span class="badge" [ngClass]="getPriorityClass(ticket.priority)" [style.background-color]="getPriorityColor(ticket.priority)" [style.color]="getPriorityColor(ticket.priority) ? '#fff' : null">{{ ticket.priorityText }}</span>
            </div>
            <button class="btn-toggle-chat-header" (click)="toggleChat()" [class.active]="showChat">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              {{ showChat ? 'Sohbeti Gizle' : 'Mesaj Gönder' }}
            </button>
          </div>
        </div>

        <!-- Description Area -->
        <div class="description-section">
          <div class="description-card">
            <div class="card-header">
              <h3>Talep Açıklaması</h3>
              <span class="created-at">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
                {{ ticket.createdDate | date:'dd MMM yyyy, HH:mm' }}
              </span>
            </div>
            <div class="card-body">
              <p>{{ ticket.description }}</p>
            </div>
          </div>

          @if (ticketImages.length > 0) {
            <div class="attachment-card">
              <div class="card-header">
                <h3>Eklenen Gorseller</h3>
              </div>
              <div class="image-grid">
                @for (image of ticketImages; track image) {
                  <button class="image-tile" type="button" (click)="openImagePreview(image)">
                    <img [src]="baseUrl + '/' + image" [alt]="ticket.title" class="ticket-image">
                    <div class="image-overlay">
                      <span>Buyutmek icin tikla</span>
                    </div>
                  </button>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Right Column: Sidebar -->
      <div class="ticket-right-column">
        <!-- Ticket Info Grid -->
        <div class="info-sidebar-grid">
          <div class="info-card-compact">
            <div class="info-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
            </div>
            <div class="info-content">
              <span class="info-label">Oluşturulma</span>
              <span class="info-value">{{ ticket.createdDate | date:'dd.MM.yyyy HH:mm' }}</span>
            </div>
          </div>

          @if (ticket.updatedDate) {
            <div class="info-card-compact">
              <div class="info-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
              </div>
              <div class="info-content">
                <span class="info-label">Son Güncelleme</span>
                <span class="info-value">{{ ticket.updatedDate | date:'dd.MM.yyyy HH:mm' }}</span>
              </div>
            </div>
          }

          @if (ticket.assetName) {
            <div class="info-card-compact">
              <div class="info-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                  <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                </svg>
              </div>
              <div class="info-content">
                <span class="info-label">ilgili Varlık</span>
                <span class="info-value">{{ ticket.assetName }}</span>
              </div>
            </div>
          }

          @if (ticket.assignedPerson) {
            <div class="info-card-compact">
              <div class="info-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
              </div>
              <div class="info-content">
                <span class="info-label">Atanan Kişi</span>
                <span class="info-value">{{ ticket.assignedPerson }}</span>
              </div>
            </div>
          }
        </div>

        <!-- Chat Content -->
        @if (showChat) {
          <div class="comments-sidebar-section">
            <div class="comments-header">
              <h3>Mesajlar ({{ comments.length }})</h3>
              <button class="btn-close-chat-sidebar" (click)="toggleChat()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>

            <div class="comments-list-sidebar" #commentsContainer>
              @if (comments.length === 0) {
                <div class="no-comments-v2">
                  <p>Henüz mesaj bulunmuyor.</p>
                </div>
              } @else {
                @for (comment of comments; track comment.id) {
                  <div class="comment-v2" [class.admin-comment]="comment.isAdminReply">
                    <div class="comment-header-v2">
                      <span class="author-name-v2">{{ comment.authorName }}</span>
                      <span class="author-role-v2" *ngIf="comment.isAdminReply">Destek</span>
                      <span class="comment-date-v2">{{ comment.createdDate | date:'HH:mm' }}</span>
                    </div>
                    <p class="comment-message-v2">{{ comment.message }}</p>
                  </div>
                }
              }
            </div>

            <!-- Add Comment Inline -->
            @if (isTicketClosed()) {
              <div class="add-comment-sidebar closed">
                <div class="closed-message">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  <p>Bu destek talebi üzerinde artık yorum yapılamaz.</p>
                </div>
              </div>
            } @else {
              <div class="add-comment-sidebar">
                @if (errorMessage) {
                  <div class="alert-error-inline">
                    {{ errorMessage }}
                  </div>
                }
                @if (uploadSuccessMessage) {
                  <div class="alert-success-inline">
                    {{ uploadSuccessMessage }}
                  </div>
                }
                <div class="textarea-container">
                  <textarea 
                    [(ngModel)]="newComment" 
                    placeholder="Mesajınızı yazın..."
                    rows="2"></textarea>
                  <div class="action-buttons">
                    <input 
                      type="file" 
                      id="fileInput" 
                      accept="image/*" 
                      multiple
                      (change)="onFileSelected($event)"
                      style="display: none;">
                    <button 
                      class="btn-attachment" 
                      (click)="triggerFileInput()" 
                      [disabled]="isUploadingFile || isTicketClosed()"
                      title="Resim ekle">
                      <svg *ngIf="!isUploadingFile" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                      </svg>
                      <span *ngIf="isUploadingFile" class="spinner-mini"></span>
                    </button>
                    <button 
                      class="btn-send-mini" 
                      (click)="addComment()" 
                      [disabled]="!newComment.trim() || isSubmittingComment || isTicketClosed()">
                      <svg *ngIf="!isSubmittingComment" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                      </svg>
                      <span *ngIf="isSubmittingComment" class="spinner-mini"></span>
                    </button>
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
           <div class="chat-placeholder-card">
             <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
               <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
             </svg>
             <p>Destek ekibiyle iletişime geçmek için yukarıdaki butonu kullanın.</p>
           </div>
        }
      </div>
    </div>
  }
</div>

@if (showImagePreview) {
  <div class="image-preview-overlay" (click)="showImagePreview = false">
    <div class="preview-content" (click)="$event.stopPropagation()">
      <button class="btn-close-preview" (click)="showImagePreview = false">x</button>
      <img [src]="baseUrl + '/' + selectedImagePath" alt="Buyuk Gorsel">
    </div>
  </div>
}
